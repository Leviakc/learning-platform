---
import { getEntry } from "astro:content";
import LessonLayout from "@/layouts/LessonLayout.astro";
import { Icon } from "astro-icon/components";
import Button from "@/components/ui/button/Button.astro";
import { MonacoEditor } from "@/components/solid/MonacoEditor"; // Your SolidJS component
import type { Lesson } from "@/types/lesson";
import type { Exercise } from "@/types/exercise";
import { orderedPythonLessons } from "@/utils/getOrderPythonLessons";
import ExerciseLayout from "@/layouts/ExerciseLayout.astro";

export async function getStaticPaths() {
  const topics = [
    ...new Set(orderedPythonLessons.map((lesson) => lesson.id.split("/")[0])),
  ];

  return topics.map((topic, index) => {
    const nextTopic = index < topics.length - 1 ? topics[index + 1] : null;
    return {
      params: { topic: topic },
      props: {
        topic,
        nextTopic,
      },
    };
  });
}

const { topic, nextTopic } = Astro.props;

const exercise = await getEntry("python", `${topic}/exercise`);
const lesson = await getEntry("python", `${topic}/lesson`);

const data = lesson?.data as Lesson;
const exerciseData = exercise?.data as Exercise;

const initialEditorCode = exercise?.body
  ? exercise.body
      .split("\n")
      .map((line) => {
        if (line === "\n" || line.trim() === "") return line;
        return `# ${line}`;
      })
      .join("\n")
  : "";
---

<LessonLayout title={data.title} description={data.description}>
  <ExerciseLayout
    title={exerciseData.title || "Test"}
    description="Create variables of different types and print them."
  >
    <button
      class="border-input bg-background hover:bg-accent hover:text-accent-foreground inline-flex h-9 items-center justify-center gap-2 rounded-md border px-3 text-sm font-medium whitespace-nowrap"
    >
      <Icon name="refresh-ccw" />
      Reset
    </button>

    <button
      class="bg-primary text-primary-foreground hover:bg-primary/90 inline-flex h-9 items-center justify-center gap-2 rounded-md px-3 text-sm font-medium whitespace-nowrap"
    >
      <Icon name="play" class="mr-4" />
      Run Tests
    </button>

    <MonacoEditor
      client:only="solid-js"
      slot={"code-editor"}
      initialCode={initialEditorCode || ""}
    />

    <!-- Test Results (your SolidJS component) -->
    <!-- <div slot="test-results" id="test-results-container"> -->
    <!-- </div> -->

    <div slot="status" class="text-center" id="exercise-status">
      <p class="text-muted-foreground text-sm">
        0 of 3 tests passed. Complete all tests to continue.
      </p>
    </div>
  </ExerciseLayout>

  <Fragment slot="footer">
    <div class="mt-8 flex justify-between" id="lesson-navigation">
      <Button variant="outline" href={`/python/lessons/${topic}`}>
        <Icon name="arrow-left" />
        Back to Lesson
      </Button>

      {
        nextTopic ? (
          <Button href={`/python/lessons/${nextTopic}`}>
            Next Lesson
            <Icon name="arrow-right" />
          </Button>
        ) : null
      }
    </div>
  </Fragment>
</LessonLayout>
